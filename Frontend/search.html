<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Campus Connect - Search</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="stylesheet" href="skeleton.css" />
  <style>
    :root { --header-h:66px; --bg:#0e1114; --panel:#14181d; --border:#1f252b; --accent:#2563eb; --accent2:#4f46e5; --text:#e6edf3; --sub:#8b9aa6; font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    * { box-sizing:border-box; }
    body {margin:0; background:var(--bg); color:var(--text); font:400 14px/1.4 'Inter',system-ui,sans-serif; -webkit-font-smoothing:antialiased;}
    /* Sticky header */
    .search-header {position:sticky; top:0; z-index:20; background:rgba(14,17,20,.9); backdrop-filter:blur(10px); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:.75rem; padding:.65rem clamp(.75rem,2vw,1.25rem);}
    .search-header .logo-btn {background:none; border:none; color:var(--text); display:flex; align-items:center; gap:.4rem; font-size:1rem; font-weight:600; cursor:pointer; padding:.45rem .7rem; border-radius:10px;}
    .search-header .logo-btn:hover {background:#1b2229;}
    .search-bar {position:relative; flex:1;}
    .search-bar i {position:absolute; top:50%; left:.85rem; transform:translateY(-50%); color:var(--sub); font-size:.9rem;}
    #searchInput {width:100%; background:#1a2128; border:1px solid #242d35; padding:.65rem .9rem .65rem 2.3rem; border-radius:12px; color:#fff; font:inherit; font-size:.85rem; letter-spacing:.3px; outline:none;}
    #searchInput:focus {border-color:#2f4254; background:#1d252d;}
    .cancel-btn {background:transparent; border:none; color:var(--sub); font:inherit; font-size:.8rem; font-weight:600; letter-spacing:.5px; cursor:pointer; padding:.5rem .75rem; border-radius:8px; text-transform:uppercase;}
    .cancel-btn:hover {background:#1b232a; color:#fff;}
    /* Tabs */
    .tabs {display:flex; gap:.55rem; padding:.55rem clamp(.75rem,2vw,1.25rem) 0; position:sticky; top:var(--header-h); background:linear-gradient(to bottom,rgba(14,17,20,0.92) 70%, rgba(14,17,20,0)); backdrop-filter:blur(8px); z-index:15;}
    .tab-btn {flex:0 0 auto; background:#161d23; border:1px solid #242d2f; color:#97a6b4; padding:.55rem 1rem; font:600 .62rem/1 'Inter',sans-serif; letter-spacing:.7px; border-radius:30px; cursor:pointer; text-transform:uppercase; transition:.25s;}
    .tab-btn.active {background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff; border-color:transparent; box-shadow:0 4px 16px -6px rgba(0,0,0,.55);} 
    .tab-btn:hover:not(.active){background:#1d2730; color:#dce4ea;}
    /* Content wrapper */
    .content {max-width:1180px; margin:0 auto; padding:0 clamp(.75rem,2vw,1.25rem) 3rem;}
    .sections {display:none; animation:fade .35s ease;}
    .sections.active {display:block;}
    @keyframes fade {from {opacity:0; transform:translateY(6px);} to {opacity:1; transform:translateY(0);} }
    /* Lists */
    .accounts, .tags, .places {display:grid; gap:.75rem; grid-template-columns:repeat(auto-fill,minmax(230px,1fr)); margin:1.2rem 0 2rem;}
    .accounts .item, .tags .item, .places .item {background:var(--panel); border:1px solid var(--border); padding:.9rem .95rem; border-radius:16px; position:relative; overflow:hidden; display:flex; align-items:center; gap:.8rem; cursor:pointer; transition:.3s;}
    .accounts .item:hover, .tags .item:hover, .places .item:hover {background:#1d242b; border-color:#2a343d;}
    .avatar {width:48px; height:48px; border-radius:14px; object-fit:cover; background:#222; flex-shrink:0;}
    .meta h4 {margin:0 0 4px; font-size:.78rem; font-weight:600; letter-spacing:.4px;}
    .meta p {margin:0; font-size:.6rem; color:var(--sub); letter-spacing:.35px;}
    .follow-btn {margin-left:auto; background:#1f2730; color:#d9e2ea; border:1px solid #27323c; padding:.45rem .85rem; font-size:.6rem; font-weight:600; letter-spacing:.6px; border-radius:8px; cursor:pointer; text-transform:uppercase;}
    .follow-btn:hover {background:#24303a;}
    .hash {font-size:.8rem; font-weight:600; color:#d8e2ea;}
    .count {font-size:.55rem; color:var(--sub); margin-top:4px; letter-spacing:.5px;}
    .place-icon {width:42px; height:42px; border-radius:12px; background:#202932; display:flex; align-items:center; justify-content:center; color:#6ba3ff; font-size:1rem;}
    /* Top tab composite */
    .top-grid {display:grid; gap:1rem; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); margin:1.25rem 0 1.6rem;}
    .post {position:relative; aspect-ratio:1/1; border-radius:18px; overflow:hidden; background:#111; cursor:pointer; border:1px solid #20272d;}
    .post img {width:100%; height:100%; object-fit:cover; filter:brightness(.9); transition:.4s;}
    .post:after {content:""; position:absolute; inset:0; background:linear-gradient(180deg,rgba(0,0,0,0) 50%,rgba(0,0,0,.55)); opacity:0; transition:.4s;}
    .post:hover img {transform:scale(1.07); filter:brightness(.65);} .post:hover:after {opacity:1;}
    .post .overlay {position:absolute; left:10px; bottom:8px; z-index:2; display:flex; flex-direction:column; gap:4px;}
    .post .overlay h5 {margin:0; font-size:.63rem; letter-spacing:.4px; font-weight:600; color:#fff;}
    .post .overlay span {font-size:.5rem; color:#c8d3dd; letter-spacing:.5px;}
    .section-label {display:flex; align-items:center; gap:.6rem; margin:1.8rem 0 .4rem; font-size:.7rem; letter-spacing:.6px; font-weight:600; color:#91a2b1; text-transform:uppercase;}
    .inline-list {display:flex; gap:.55rem; flex-wrap:wrap; margin:.7rem 0 1.4rem;}
    .chip {background:#1a2229; padding:.45rem .8rem; border-radius:30px; font-size:.62rem; font-weight:600; letter-spacing:.6px; color:#d2dde5; border:1px solid #242d35; cursor:pointer; transition:.3s;}
    .chip:hover {background:#222d35;}
    /* Suggestions popover under search bar */
    .suggest-popover{position:absolute; top:calc(100% + 6px); left:0; right:0; background:#12171c; border:1px solid #242d35; border-radius:12px; padding:.6rem .65rem; box-shadow:0 12px 24px -16px rgba(0,0,0,.85); z-index:30;}
    .suggest-popover .title{display:flex; align-items:center; gap:.5rem; font-size:.65rem; letter-spacing:.6px; font-weight:700; color:#9fb1bf; text-transform:uppercase; margin:0 0 .4rem;}
    .suggest-popover .inline-list{margin:.2rem 0 .2rem;}
    .clear-recents-btn.small{font-size:.48rem; padding:.28rem .45rem; margin-left:auto;}
  .suggest-actions{display:flex; justify-content:flex-end; margin-top:.2rem;}
  .icon-gap{margin-right:.25rem;}
  .divider.tight{margin:1.4rem 0 1.6rem;}
  .grid-160{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));}
  /* Recents */
  .recents-header {display:flex; align-items:center; gap:.6rem; margin:1.2rem 0 .4rem; font-size:.7rem; letter-spacing:.6px; font-weight:600; color:#91a2b1; text-transform:uppercase;}
  .clear-recents-btn {margin-left:auto; background:#1b232a; border:1px solid #27323b; color:#9fb1bf; font:600 .52rem/1 'Inter',sans-serif; letter-spacing:.8px; padding:.38rem .55rem; border-radius:6px; cursor:pointer;}
  .clear-recents-btn:hover {background:#232e36; color:#fff;}
  .recent-chip {position:relative; padding-right:1.6rem;}
  .recent-chip .remove {position:absolute; top:50%; right:.4rem; transform:translateY(-50%); background:transparent; border:none; color:#96a6b3; font-size:.65rem; cursor:pointer; padding:2px; border-radius:4px;}
  .recent-chip .remove:hover {color:#fff; background:#27323b;}
    .empty {margin:2.5rem 0 3rem; font-size:.75rem; color:var(--sub);}
    /* Utilities */
    .divider {height:1px; width:100%; background:linear-gradient(to right,transparent,#27333c,transparent); margin:2.6rem 0 2rem; border:none;}
    ::-webkit-scrollbar {width:10px;} ::-webkit-scrollbar-track {background:transparent;} ::-webkit-scrollbar-thumb {background:#1e2730; border-radius:6px;} ::-webkit-scrollbar-thumb:hover {background:#27323b;}
    @media (max-width:900px){ .content {padding:0 .9rem 2.5rem;} .tabs {padding-left:.9rem; padding-right:.9rem;} }
    @media (max-width:640px){ .tab-btn {padding:.5rem .75rem; font-size:.58rem;} .accounts,.tags,.places {grid-template-columns:repeat(auto-fill,minmax(180px,1fr));} #searchInput {font-size:.8rem;} }
  </style>
</head>
<body class="loading">
  <div class="skeleton-overlay generic content">
    <div class="skel-stack">
      <div class="skel-bar w-40 tall"></div>
      <div class="skel-row"><div class="skel-pill"></div><div class="skel-pill"></div><div class="skel-pill"></div><div class="skel-pill"></div></div>
  <div class="skel-card-grid grid-160">
        <div class="skel-card"></div><div class="skel-card"></div><div class="skel-card"></div><div class="skel-card"></div>
      </div>
    </div>
  </div>
  <div class="real-content">
  <header class="search-header" role="banner">
    <button class="logo-btn" onclick="location.href='feed.html'" aria-label="Back to feed"><i class="fas fa-arrow-left"></i><span>Search</span></button>
    <div class="search-bar" role="search">
      <i class="fas fa-magnifying-glass" aria-hidden="true"></i>
      <input id="searchInput" type="search" placeholder="Search" autocomplete="off" aria-label="Search" />
      <!-- Suggestions popover: recent searches as chips -->
      <div id="searchSuggest" class="suggest-popover" hidden>
        <div class="title"><i class="fas fa-clock"></i> Recent</div>
        <div class="inline-list" id="suggestChips"></div>
        <div class="suggest-actions">
          <button id="clearSuggestRecents" type="button" class="clear-recents-btn small">Clear recents</button>
        </div>
      </div>
    </div>
    <button id="cancelBtn" class="cancel-btn" type="button">Cancel</button>
  </header>

  <div class="tabs" role="tablist" aria-label="Search categories">
    <button class="tab-btn active" data-tab="top" role="tab" aria-selected="true">Top</button>
    <button class="tab-btn" data-tab="accounts" role="tab" aria-selected="false">Accounts</button>
    <button class="tab-btn" data-tab="tags" role="tab" aria-selected="false">Tags</button>
    <button class="tab-btn" data-tab="places" role="tab" aria-selected="false">Places</button>
  </div>

  <main class="content" aria-live="polite">
    <!-- Top -->
    <section id="panel-top" class="sections active" role="tabpanel" aria-labelledby="Top tab">
      <div id="recentBlock" hidden>
        <div class="recents-header"><i class="fas fa-clock"></i> Recent Searches <button id="clearRecents" type="button" class="clear-recents-btn">Clear</button></div>
        <div class="inline-list" id="recentChips"></div>
  <hr class="divider tight" />
      </div>
      <h4 class="section-label"><i class="fas fa-user"></i> Suggested Accounts</h4>
      <div class="accounts" id="topAccounts"></div>
      <h4 class="section-label"><i class="fas fa-hashtag"></i> Trending Tags</h4>
      <div class="inline-list" id="topTags"></div>
      <h4 class="section-label"><i class="fas fa-location-dot"></i> Places</h4>
      <div class="inline-list" id="topPlacesWrap"></div>
      <h4 class="section-label"><i class="fas fa-images"></i> Trending Posts</h4>
      <div class="top-grid" id="topPosts"></div>
    </section>
    <!-- Accounts -->
    <section id="panel-accounts" class="sections" role="tabpanel">
      <div class="accounts" id="accountsList"></div>
      <p class="empty" id="accountsEmpty" hidden>No matching accounts.</p>
    </section>
    <!-- Tags -->
    <section id="panel-tags" class="sections" role="tabpanel">
      <div class="tags" id="tagsList"></div>
      <p class="empty" id="tagsEmpty" hidden>No matching tags.</p>
    </section>
    <!-- Places -->
    <section id="panel-places" class="sections" role="tabpanel">
      <div class="places" id="placesList"></div>
      <p class="empty" id="placesEmpty" hidden>No matching places.</p>
    </section>
  </main>

  </div>
  <script src="skeleton.js"></script>
  <script>
    // API base helper: use current origin if it's the backend; otherwise fallback to localhost:5000
    const DEFAULT_API = 'http://localhost:5000';
    const API_BASE = (location.origin && location.origin.includes('localhost:5000')) ? location.origin : DEFAULT_API;
    // Sample Data
    const posts = [
      {id:1,title:'Hackathon Night',tag:'coding',img:'https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=600&h=600&fit=crop'},
      {id:2,title:'Cultural Fest',tag:'culture',img:'https://images.unsplash.com/photo-1464146072230-91cabc968266?w=600&h=600&fit=crop'},
      {id:3,title:'Esports Finals',tag:'esports',img:'https://images.unsplash.com/photo-1606112219348-204d7d8b94ee?w=600&h=600&fit=crop'},
      {id:4,title:'Study Jam',tag:'study',img:'https://images.unsplash.com/photo-1492538368677-f6e0afe31dcc?w=600&h=600&fit=crop'},
      {id:5,title:'Design Sprint',tag:'design',img:'https://images.unsplash.com/photo-1545239351-1141bd82e8a6?w=600&h=600&fit=crop'},
      {id:6,title:'Athletics',tag:'sports',img:'https://images.unsplash.com/photo-1518611012118-f0c5d7d3e6b3?w=600&h=600&fit=crop'}
    ];
    const accounts = [
      {name:'Asha', role:'Dance Club', img:'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=200&h=200&fit=crop&crop=face'},
      {name:'Mike', role:'Coding Society', img:'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200&h=200&fit=crop&crop=face'},
      {name:'Priya', role:'Food Blogger', img:'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=200&h=200&fit=crop&crop=face'},
      {name:'Robotics Club', role:'Innovation Hub', img:'https://images.unsplash.com/photo-1529333166437-7750a6dd5a70?w=400&h=400&fit=crop'},
      {name:'UI Society', role:'Design Circle', img:'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=200&h=200&fit=crop&crop=face'}
    ];
    const tags = [
      {tag:'#CampusLife', count:1280}, {tag:'#CodeRush', count:860}, {tag:'#FridayFeels', count:540},
      {tag:'#EsportsFinals', count:420}, {tag:'#DesignSprint', count:390}, {tag:'#StudyJam', count:350}, {tag:'#TalentShow', count:310}
    ];
    const places = [
      {place:'Main Auditorium', area:'North Block'}, {place:'Innovation Lab', area:'Tech Wing'},
      {place:'Central Library', area:'Knowledge Center'}, {place:'Sports Complex', area:'West Field'},
      {place:'Cafeteria Hub', area:'Commons'}
    ];

    const qs = sel => document.querySelector(sel);
    const qsa = sel => [...document.querySelectorAll(sel)];
    const searchInput = qs('#searchInput');
    const cancelBtn = qs('#cancelBtn');
    const tabButtons = qsa('.tab-btn');

    // Containers
    const topPostsEl = qs('#topPosts');
    const topAccountsEl = qs('#topAccounts');
    const topTagsEl = qs('#topTags');
    const topPlacesWrap = qs('#topPlacesWrap');
    const accountsList = qs('#accountsList');
    const tagsList = qs('#tagsList');
    const placesList = qs('#placesList');
    const accountsEmpty = qs('#accountsEmpty');
    const tagsEmpty = qs('#tagsEmpty');
    const placesEmpty = qs('#placesEmpty');
  // Recents elements
  const recentBlock = qs('#recentBlock');
  const recentChips = qs('#recentChips');
  const clearRecentsBtn = qs('#clearRecents');
  // Suggestion elements
  const suggest = qs('#searchSuggest');
  const suggestChips = qs('#suggestChips');
  const clearSuggestRecents = qs('#clearSuggestRecents');

    // Render helpers
    function renderTop(){
      topPostsEl.innerHTML = posts.map(p=>`<div class="post" title="${p.title}"><img src="${p.img}" alt="${p.title}"><div class="overlay"><h5>${p.title}</h5><span>${p.tag}</span></div></div>`).join('');
      topAccountsEl.innerHTML = accounts.slice(0,4).map(acc=>accountCard(acc)).join('');
      topTagsEl.innerHTML = tags.slice(0,8).map(t=>`<button class="chip" data-tag="${t.tag}">${t.tag}</button>`).join('');
      topPlacesWrap.innerHTML = places.slice(0,4).map(pl=>`<button class="chip" data-place="${pl.place}"><i class="fas fa-location-dot"></i> ${pl.place}</button>`).join('');
    }

    function accountCard(a){
      return `<div class="item" data-account="${a.name}"><img class="avatar" src="${a.img}" alt="${a.name}"><div class="meta"><h4>${a.name}</h4><p>${a.role}</p></div><button class="follow-btn" type="button">Follow</button></div>`;
    }
    function tagCard(t){
      return `<div class="item" data-tag="${t.tag}"><div class="meta"><span class="hash">${t.tag}</span><div class="count">${t.count.toLocaleString()} posts</div></div></div>`;
    }
    function placeCard(p){
      return `<div class="item" data-place="${p.place}"><div class="place-icon"><i class="fas fa-location-dot"></i></div><div class="meta"><h4>${p.place}</h4><p>${p.area}</p></div></div>`;
    }

    function filterAll(q){
      if(!q) return {posts, accounts, tags, places};
      q = q.toLowerCase();
      return {
        posts: posts.filter(p=>p.title.toLowerCase().includes(q) || p.tag.includes(q)),
        accounts: accounts.filter(a=>a.name.toLowerCase().includes(q) || a.role.toLowerCase().includes(q)),
        tags: tags.filter(t=>t.tag.toLowerCase().includes(q)),
        places: places.filter(p=>p.place.toLowerCase().includes(q) || p.area.toLowerCase().includes(q))
      };
    }

    // Recent Searches
    const RECENT_KEY = 'cc_recent_searches_v1';
    const MAX_RECENTS = 12;
    function loadRecents(){ try { return JSON.parse(localStorage.getItem(RECENT_KEY))||[]; } catch { return []; } }
    function saveRecents(list){ localStorage.setItem(RECENT_KEY, JSON.stringify(list.slice(0,MAX_RECENTS))); }
    function addRecent(term){
      term = term.trim(); if(!term) return;
      let recents = loadRecents();
      const idx = recents.findIndex(r=>r.toLowerCase()===term.toLowerCase());
      if(idx>=0) recents.splice(idx,1);
      recents.unshift(term);
      saveRecents(recents);
      renderRecents();
    }
    function removeRecent(term){
      const recents = loadRecents().filter(r=>r!==term);
      saveRecents(recents);
      renderRecents();
    }
    function renderRecents(){
      const recents = loadRecents();
      if(!recents.length){ recentBlock.hidden = true; return; }
      const q = searchInput.value.trim();
      const active = document.querySelector('.tab-btn.active').dataset.tab;
      recentBlock.hidden = !(active==='top' && q==='');
      recentChips.innerHTML = recents.map(r=>`<div class="chip recent-chip" data-recent="${r}"><i class="fas fa-clock" style="margin-right:.25rem;"></i>${r}<button class="remove" data-remove="${r}" aria-label="Remove ${r}">✕</button></div>`).join('');
    }

    // Suggestions rendering (inside search bar)
    function renderSuggest(){
      const recents = loadRecents();
      const q = searchInput.value.trim().toLowerCase();
      const list = q ? recents.filter(r => r.toLowerCase().includes(q)) : recents;
      if(list.length){
        suggest.hidden = false;
  suggestChips.innerHTML = list.map(r=>`<div class="chip recent-chip" data-suggest="${r}"><i class="fas fa-clock icon-gap"></i>${r}<button class="remove" data-remove="${r}" aria-label="Remove ${r}">✕</button></div>`).join('');
      } else {
        suggest.hidden = true;
        suggestChips.innerHTML = '';
      }
    }

    function setAccountsEmpty(message){
      if(accountsEmpty){ accountsEmpty.textContent = message; accountsEmpty.hidden = false; }
    }

  async function renderTab(){
      const active = document.querySelector('.tab-btn.active').dataset.tab;
      const q = searchInput.value.trim();
      const data = filterAll(q);
      if(active==='top'){
        topPostsEl.innerHTML = data.posts.map(p=>`<div class="post"><img src="${p.img}" alt="${p.title}"><div class="overlay"><h5>${p.title}</h5><span>${p.tag}</span></div></div>`).join('');
        topAccountsEl.innerHTML = data.accounts.slice(0,4).map(accountCard).join('');
        topTagsEl.innerHTML = data.tags.slice(0,8).map(t=>`<button class="chip">${t.tag}</button>`).join('');
        topPlacesWrap.innerHTML = data.places.slice(0,6).map(pl=>`<button class="chip"><i class="fas fa-location-dot"></i> ${pl.place}</button>`).join('');
        renderRecents();
      } else if(active==='accounts') {
        // Backend-powered account search
        const query = q.trim();
        if(!query){
          accountsList.innerHTML = '';
          setAccountsEmpty('Type a username or name to search accounts.');
        } else {
          accountsList.innerHTML = '<p style="opacity:.7; padding:.4rem;">Searching…</p>';
          accountsEmpty.hidden = true;
          try {
            const users = await searchAccountsBackend(query);
            accountsList.innerHTML = users.map(userCard).join('');
            if(users.length === 0){
              setAccountsEmpty('No users found');
            } else {
              accountsEmpty.hidden = true;
            }
          } catch(err){
            console.error('Search failed', err);
            accountsList.innerHTML = '';
            setAccountsEmpty('Error searching users');
          }
        }
      } else if(active==='tags') {
        tagsList.innerHTML = data.tags.map(tagCard).join('');
        tagsEmpty.hidden = data.tags.length !== 0;
      } else if(active==='places') {
        placesList.innerHTML = data.places.map(placeCard).join('');
        placesEmpty.hidden = data.places.length !== 0;
      }
    }

    // Tab switching
    function switchTab(name){
      const btn = Array.from(tabButtons).find(b=>b.dataset.tab===name);
      if(!btn) return;
      tabButtons.forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
      btn.classList.add('active'); btn.setAttribute('aria-selected','true');
      document.querySelectorAll('.sections').forEach(sec=>sec.classList.remove('active'));
      qs('#panel-'+btn.dataset.tab).classList.add('active');
      renderTab();
    }

    tabButtons.forEach(btn=>btn.addEventListener('click', ()=>{
      if(btn.classList.contains('active')) return;
      switchTab(btn.dataset.tab);
    }));

    // Search input
  searchInput.addEventListener('input', ()=> {
    const q = searchInput.value.trim();
    // Auto-switch to Accounts tab for username searches
    if(q && document.querySelector('.tab-btn.active')?.dataset.tab !== 'accounts'){
      switchTab('accounts');
    } else {
      renderTab();
    }
    renderSuggest();
  });
  searchInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ addRecent(searchInput.value); suggest.hidden = true; if(document.querySelector('.tab-btn.active')?.dataset.tab!=='accounts'){ switchTab('accounts'); } else { renderTab(); } } });
    searchInput.addEventListener('keydown', e=>{ if(e.key==='Escape'){ searchInput.value=''; renderTab(); suggest.hidden = true; searchInput.blur(); } });
    searchInput.addEventListener('focus', ()=>{ renderSuggest(); });
    searchInput.addEventListener('blur', ()=>{ setTimeout(()=>{ suggest.hidden = true; }, 120); });
    cancelBtn.addEventListener('click', ()=>{ if(searchInput.value){ searchInput.value=''; renderTab(); } else { window.location.href='feed.html'; } });

    // Recent interactions
    clearRecentsBtn.addEventListener('click', ()=>{ localStorage.removeItem(RECENT_KEY); renderRecents(); renderSuggest(); });
    recentChips.addEventListener('click', e=>{
      const removeBtn = e.target.closest('[data-remove]');
      if(removeBtn){ removeRecent(removeBtn.getAttribute('data-remove')); return; }
      const chip = e.target.closest('[data-recent]');
      if(chip){ searchInput.value = chip.getAttribute('data-recent'); renderTab(); }
    });
    // Suggestion interactions inside popover
    clearSuggestRecents.addEventListener('click', ()=>{ localStorage.removeItem(RECENT_KEY); renderRecents(); renderSuggest(); });
    suggest.addEventListener('click', (e)=>{
      const removeBtn = e.target.closest('[data-remove]');
      if(removeBtn){ removeRecent(removeBtn.getAttribute('data-remove')); renderSuggest(); return; }
      const chip = e.target.closest('[data-suggest]');
      if(chip){ const val = chip.getAttribute('data-suggest'); searchInput.value = val; addRecent(val); suggest.hidden = true; if(document.querySelector('.tab-btn.active')?.dataset.tab!=='accounts'){ switchTab('accounts'); } else { renderTab(); } }
    });

    // Capture clicks on top chips / accounts to store recents
    document.addEventListener('click', e=>{
      const tagChip = e.target.closest('#topTags .chip');
      if(tagChip){ addRecent(tagChip.textContent.trim()); return; }
      const placeChip = e.target.closest('#topPlacesWrap .chip');
      if(placeChip){ addRecent(placeChip.textContent.replace(/^[^A-Za-z0-9#]+/,'').trim()); return; }
      const accountItem = e.target.closest('#topAccounts .item');
      if(accountItem){ const name = accountItem.querySelector('h4')?.textContent; if(name) addRecent(name); }
    });

    // Backend users search wiring
    function authHeader(){
      const t = localStorage.getItem('authToken');
      return t ? { 'Authorization': 'Bearer ' + t } : {};
    }
    async function searchAccountsBackend(q){
      const res = await fetch(API_BASE + '/api/users/search?q=' + encodeURIComponent(q), { headers: authHeader() });
      const data = await res.json();
      return data?.users || [];
    }
    function userCard(u){
      const privacy = u.is_private ? ' <span style="font-size:.7rem; color:#9db0bf;">(Private)</span>' : '';
      const name = u.full_name || '';
      const status = (u.follow_status || 'none');
      let label = 'Follow';
      if(status==='accepted') label='Following';
      else if(status==='requested') label='Requested';
      return `<div class="item" data-username="${u.username}">
        <img class="avatar" src="https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(u.username)}" alt="${u.username}">
        <div class="meta"><h4>@${u.username}${privacy}</h4><p>${name}</p></div>
        <button class="follow-btn" data-uid="${u.id}" data-state="${status}" type="button">${label}</button>
      </div>`;
    }
    accountsList.addEventListener('click', async (e)=>{
      const followBtn = e.target.closest('.follow-btn');
      if(followBtn){
        e.stopPropagation();
        const uid = followBtn.getAttribute('data-uid');
        const state = followBtn.getAttribute('data-state') || 'none';
        try {
          if(state==='accepted'){
            await fetch(API_BASE + '/api/follow/'+uid, { method:'DELETE', headers: authHeader() });
          } else if(state==='requested' || state==='none'){
            await fetch(API_BASE + '/api/follow/'+uid, { method:'POST', headers: authHeader() });
          }
        } catch {}
        // Refresh this button state
        try {
          const r = await fetch(API_BASE + '/api/follow/status/'+uid, { headers: authHeader() });
          const d = await r.json(); const s = d?.status || 'none';
          followBtn.setAttribute('data-state', s);
          let label = 'Follow';
          if(s==='accepted') label = 'Following';
          else if(s==='requested') label = 'Requested';
          followBtn.textContent = label;
        } catch {}
        return;
      }
      const item = e.target.closest('.item[data-username]');
      if(item){
        const uname = item.getAttribute('data-username');
        window.location.href = 'profile.html?user=' + encodeURIComponent(uname);
      }
    });

    // Initial
    renderTop();
    renderTab();
    renderRecents();
    renderSuggest();
  </script>
</body>
</html>